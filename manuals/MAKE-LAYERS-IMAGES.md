# 制作分层镜像

AINUC®️云固件（Multiware）是基于UEFI标准的固件扩展应用程序，通过将包含虚拟磁盘的镜像文件模拟为标准磁盘，实现了镜像文件内操作系统启动、多镜像文件切换以及复杂应用系统（包含操作系统、驱动程序、应用软件、配置信息、用户数据）快速部署，亦可支持虚拟磁盘镜像文件部署在移动存储设备。

镜像文件就相当于物理硬盘。镜像文件有很多种格式，比如最常见的raw格式，也就是把硬盘上的数据1：1的复制到文件中。Windows系统通常使用VHD/VHDx作为基本镜像格式，Linux平台通常使用HDD/RAW格式，其他虚拟化平台还使用VMDK、VDI、QCOW/QCOW2等多种格式。

云固件官方提供了常见系统及常见机型的镜像存储仓库，仓库内保存镜像文件的说明及配套文件，镜像文件及镜像文件压缩文件可参考下载地址，通常使用百度网盘提供。推荐使用官方提供的基础镜像。

## 默认格式

云固件通常使用VHD(x)作为标准的镜像格式，但制作的方法和微软提供的VHD(x)镜像格式制作过程有很大的不同。

## 格式差异

具体差异主要表现在微软要求的本地启动VHD镜像使用位于VHD(x)文件之外的引导管理器（Boot Loader），而云固件使用VHD(x)镜像文件内ESP分区内的引导管理器。因此，云固件使用的VHD(x)镜像文件是可以作为虚拟机的磁盘启动的，但微软要求的本地启动VHD(x)镜像是无法启动，原因是缺少ESP分区。

VHD(x)镜像格式支持Fixed、Dynamic、Difference三种模式，其中Difference模式（差分模式）可以生成父子镜像，提供了快照、回滚等多种高级功能，云固件充分利用了这些能力来方便用户。

## 分层规范

云固件支持差分格式的磁盘镜像格式，为了让制作的镜像文件能够得到最大化的利用，云固件提出了如下分层规范：

1. 分层按照L0-L9来定义；
1. 高层级镜像原则上要求包含低层级全部镜像内容；
1. 除L0级别外，每个层级均可以生成差分级别；
1. 同层级的差分镜像使用层级加两位数的顺序号来区分，如301，305，501，511等；

## 制作基本镜像

在介绍基本知识时已经明确指出云固件的镜像支持虚拟机启动，因此最简单的镜像制作方式就是使用Windows Hyper-V虚拟化平台来制作。

![Hyper-V虚拟机设置](/manuals/images/hyper-v-setting.png)

操作系统安装完成后，无须安装驱动程序、升级，制备成为L1级别足以。

由于Windows 10/11 22H2更新后出现的限制，原先支持的Dism释放后直接从L0制备的方式目前已经不再可用。

## 在演练场里使用制备的镜像

制备得到L1级别虚拟磁盘，可以复制或者移动到“[云固件演练场](https://pan.baidu.com/s/1NxE7xWEQ1zyGDaCV4T56NQ)”文件夹内，直接更名为演练场内提供的Helper名称，然后添加到menu.config，并将menu.config在外层的总入口配置文件vd.config引入，重新启动后就可以看到启动选择菜单了。

如果希望保留L1级别虚拟磁盘，可以借助演练场内的Bootice创建差分磁盘，创建的差分磁盘文件名使用Helper要求的名称即可。

![创建差分磁盘](/manuals/images/bootice-make-diff.png)

差分后的镜像同样需要添加到menu.config，并将menu.config在外层的总入口配置文件vd.config引入方能重启后看到启动选择菜单。

## 创建自己的文件夹使用制备的镜像

用户也可以创建自己的文件夹来保存镜像文件。文件夹名称不能有空格、特殊字符和中文字符，建议使用大小写和数字命名。

云固件截至到2023/07/15日，原生支持的镜像格式为raw及固定、动态的VHD类型，通常Windows使用的vhdx格式尚未支持，使用演练场是最简单的选择。vhdx格式受云固件支持后，面向Windows的helper原则上就可以废弃了。

Helper是专门为不受云固件支持、但操作系统和基于操作系统的驱动程序支持的虚拟磁盘格式准备的。此类镜像只需配合对应的helper辅助启动镜像即可完成云固件内和原始支持格式相同的方式进行启动。

因此，创建自己的文件夹后，可以复制演练场内的helper文件过来进行修改。Windows系统需要修改BCD配置信息。

![BCDEDIT](/manuals/images/bcdedit-win11.png)

如果是Windows 10/11以外的Windows系统，那么需要自行创建一个大小为64M的固定分配模式的VHD文件，并格式化为EFI分区。然后使用bcdboot命令来创建启动文件，并且还需要修改BCD配置信息。

![BCDBOOT](/manuals/images/bcdboot-win10.PNG)

以上步骤完成后，复制演练场内的menu.config文件过来，并按照文件内部说明修改对应项，最后在外层总入口配置文件vd.config内引入，启动设置就完成了。

执行制备的镜像启动后，完成一定操作后，符合分层规范要求情况下，可以分阶段保留，以备后用。

分层镜像制备中，可以根据后续使用便利来选择规范推荐的逐层包含的模式，也可以选择逐层差分的模式。

![逐层差分模式](/manuals/images/diff-every-layer.png)

至此，分层镜像制作完毕。

## Linux等其他系统的镜像制备

由于Linux等系统原生是不支持vhdx格式，所以需要独立制备helper，但helper的制备过程较为复杂，云固件的支持上也有没完善之处，镜像会提供，但暂时不提供教程。

## 结语

云固件镜像最终将支持VHD(x)各自的三种共计六种格式，RAW及ISO格式将会在特定场合上使用来方便使用者。  
更多启动参数配置说明可参考演练场menu.config内注释以及知乎上“AINUC云固件”专栏文章和视频。  
云固件相关文章和视频可在搜索引擎上搜索“云固件”或者“AINUC云固件”。  
欲了解更多信息可微信搜索“AINUC99”添加云固件小助手咨询。